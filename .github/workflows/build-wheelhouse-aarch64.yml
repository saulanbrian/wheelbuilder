name: Build wheelhouse (AArch64)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-aarch64:
    runs-on: ubuntu-latest
    env:
      # Build only Python 3.11 wheels (you can change this if needed)
      CIBW_BUILD: "cp311-*"
      CIBW_PLATFORM: "linux"
      CIBW_ARCHS: "aarch64"
      PIP_NO_WARN_SCRIPT_LOCATION: "0"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup QEMU (for cross-arch builds)
        uses: docker/setup-qemu-action@v2

      - name: Setup buildx
        uses: docker/setup-buildx-action@v2

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Upgrade pip & install build tools
        run: |
          python -m pip install --upgrade pip setuptools wheel cibuildwheel

      # ----------------------------------------------
      #      IMPROVED WHEEL BUILD STEP YOU CHOSE
      # ----------------------------------------------
      - name: Build wheelhouse by building wheels for requirements (AArch64)
        run: |
          mkdir -p wheelhouse

          # First: build wheels for all packages in your requirements.txt
          python -m pip wheel -r requirements.txt \
            -w wheelhouse \
            --platform manylinux2014_aarch64 \
            --only-binary=:all: || true

          # Second: cibuildwheel for packages requiring source builds
          python -m cibuildwheel \
            --platform linux \
            --arch aarch64 \
            --output-dir wheelhouse || true

          echo "Wheelhouse contents:"
          ls -la wheelhouse

      - name: Pack wheelhouse
        run: |
          tar -czf wheelhouse.tar.gz wheelhouse

      - name: Upload wheelhouse artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheelhouse-aarch64
          path: wheelhouse.tar.gz
